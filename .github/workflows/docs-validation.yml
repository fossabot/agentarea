name: Documentation Validation

on:
  push:
    paths:
      - 'docs/**'
  pull_request:
    paths:
      - 'docs/**'

jobs:
  validate-docs:
    name: Validate Mintlify Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'docs/package-lock.json'

      - name: Install dependencies
        working-directory: docs
        run: npm ci

      - name: Validate docs.json structure
        working-directory: docs
        run: |
          # Check if docs.json exists
          if [ ! -f "docs.json" ]; then
            echo "❌ docs.json not found"
            exit 1
          fi
          
          # Validate JSON syntax
          if ! cat docs.json | python -m json.tool > /dev/null 2>&1; then
            echo "❌ docs.json has invalid JSON syntax"
            exit 1
          fi
          
          # Check required fields
          if ! grep -q '"navigation"' docs.json; then
            echo "❌ docs.json missing required 'navigation' field"
            exit 1
          fi
          
          # Check navigation structure
          if ! python3 -c "import json; config=json.load(open('docs.json')); assert isinstance(config.get('navigation', {}), dict)" 2>/dev/null; then
            echo "❌ navigation field must be an object, not an array"
            exit 1
          fi
          
          echo "✅ docs.json structure is valid"

      - name: Validate Mintlify configuration
        working-directory: docs
        run: |
          # Check for broken links to validate configuration
          npx mint broken-links || {
            echo "❌ Mintlify broken links check failed"
            exit 1
          }

          echo "✅ Mintlify configuration is valid"

      - name: Check documentation files exist
        working-directory: docs
        run: |
          # Extract page references from docs.json and check if files exist
          python3 << 'EOF'
          import json
          import os
          import sys
          
          with open('docs.json', 'r') as f:
              config = json.load(f)
          
          missing_files = []
          
          if 'navigation' in config:
              navigation = config['navigation']
              # Handle new object format with groups
              groups = navigation.get('groups', []) if isinstance(navigation, dict) else []
              
              for section in groups:
                  if 'pages' in section:
                      for page in section['pages']:
                          # Page can be string or object {"page": "name", ...}
                          name = page if isinstance(page, str) else (page.get('page') or '')
                          if not name:
                              continue
                          md_file = f"{name}.md"
                          if not os.path.exists(md_file):
                              missing_files.append(md_file)
          
          if missing_files:
              print("❌ Missing documentation files:")
              for file in missing_files:
                  print(f"  - {file}")
              sys.exit(1)
          else:
              print("✅ All referenced documentation files exist")
          EOF

      - name: Mintlify CLI version
        working-directory: docs
        run: |
          npx mint version || {
            echo "❌ Mintlify CLI not available";
            exit 1;
          }

  link-validation:
    name: Validate Internal Links
    runs-on: ubuntu-latest
    needs: validate-docs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'docs/package-lock.json'

      - name: Install dependencies
        working-directory: docs
        run: npm ci

      - name: Validate internal links
        working-directory: docs
        run: |
          npx mint broken-links || { echo "❌ Mintlify broken links check failed"; exit 1; }
          echo "✅ Internal link validation completed"
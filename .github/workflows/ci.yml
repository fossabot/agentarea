name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      platform: ${{ steps.filter.outputs.platform }}
      platform_libs: ${{ steps.filter.outputs.platform_libs }}
      api: ${{ steps.filter.outputs.api }}
      worker: ${{ steps.filter.outputs.worker }}
      webapp: ${{ steps.filter.outputs.webapp }}
      cli: ${{ steps.filter.outputs.cli }}
      mcp_manager: ${{ steps.filter.outputs.mcp_manager }}
      bootstrap: ${{ steps.filter.outputs.bootstrap }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            platform:
              - 'agentarea-platform/**'
            platform_libs:
              - 'agentarea-platform/libs/**'
            api:
              - 'agentarea-platform/apps/api/**'
            worker:
              - 'agentarea-platform/apps/worker/**'
            webapp:
              - 'agentarea-webapp/**'
            cli:
              - 'agentarea-cli/**'
            mcp_manager:
              - 'agentarea-mcp-manager/**'
            bootstrap:
              - 'agentarea-bootstrap/**'

  platform-lint:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.platform == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "agentarea-platform/**/pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: agentarea-platform
        run: uv sync --all-extras --group dev --group lint

      - name: Run ruff check
        working-directory: agentarea-platform
        run: uv run ruff check .

      - name: Run ruff format check
        working-directory: agentarea-platform
        run: uv run ruff format --check .

  platform-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.platform == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "agentarea-platform/**/pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: agentarea-platform
        run: |
          uv sync --group dev

      - name: Run tests
        working-directory: agentarea-platform
        run: |
          uv run python -m pytest tests/unit tests/functional -m "not integration"

  # test:
  #   runs-on: ubuntu-latest
  #   services:
  #     postgres:
  #       image: postgres:15
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #         POSTGRES_DB: agentarea_test
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
      
  #     redis:
  #       image: redis:7
  #       options: >-
  #         --health-cmd "redis-cli ping"
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5

  #   steps:
  #     - uses: actions/checkout@v4
      
  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v4
  #       with:
  #         enable-cache: true
  #         cache-dependency-glob: "core/**/pyproject.toml"

  #     - name: Set up Python
  #       run: uv python install ${{ env.PYTHON_VERSION }}

  #     - name: Install dependencies
  #       working-directory: core
  #       run: |
  #         uv sync --group test
  #         uv sync --group dev

  #     - name: Run tests
  #       working-directory: core
  #       env:
  #         DATABASE_URL: postgresql://postgres:postgres@localhost:5432/agentarea_test
  #         REDIS_URL: redis://localhost:6379/0
  #       run: |
  #         uv run pytest tests/ \
  #           --cov-report=xml \
  #           --cov-report=term \
  #           --junitxml=test-results.xml \
  #           -n auto

  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v4
  #       with:
  #         file: ./core/coverage.xml
  #         flags: unittests
  #         name: codecov-umbrella

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: test-results
  #         path: core/test-results.xml

  # build:
  #   runs-on: ubuntu-latest
  #   needs: [lint, test]
  #   strategy:
  #     matrix:
  #       component: [api, worker]
    
  #   steps:
  #     - uses: actions/checkout@v4
      
  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v4
  #       with:
  #         enable-cache: true

  #     - name: Install uv (act fallback)
  #       run: |
  #         curl -Ls https://astral.sh/uv/install.sh | sh
  #         echo "$HOME/.local/bin" >> $GITHUB_PATH

  #     - name: Set up Python
  #       run: uv python install ${{ env.PYTHON_VERSION }}

  #     - name: Build package
  #       working-directory: core
  #       run: uv build apps/${{ matrix.component }}

  #     - name: Upload build artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ${{ matrix.component }}-dist
  #         path: core/dist/

  docker-api:
    if: github.ref == 'refs/heads/main' && (needs.changes.outputs.api == 'true' || needs.changes.outputs.platform_libs == 'true')
    needs: [changes, platform-lint, platform-test]
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/docker-build-push.yml
    with:
      component: api
      context: agentarea-platform
      dockerfile: agentarea-platform/apps/api/Dockerfile
      use-private-registry: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY_MIRROR: ${{ secrets.DOCKER_REGISTRY_MIRROR }}
      DOCKER_REGISTRY_MIRROR_PATH: ${{ secrets.DOCKER_REGISTRY_MIRROR_PATH }}
      DOCKER_REGISTRY_MIRROR_USERNAME: ${{ secrets.DOCKER_REGISTRY_MIRROR_USERNAME }}
      DOCKER_REGISTRY_MIRROR_PASSWORD: ${{ secrets.DOCKER_REGISTRY_MIRROR_PASSWORD }}

  performance:
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'pull_request' && needs.changes.outputs.platform == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install uv (act fallback)
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: agentarea-platform
        run: uv sync --group dev

      - name: Benchmark build performance
        working-directory: agentarea-platform
        run: |
          echo "## Build Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Build Time |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------|" >> $GITHUB_STEP_SUMMARY
          for component in api worker; do
            start_time=$(date +%s.%N)
            uv build apps/$component
            end_time=$(date +%s.%N)
            build_time=$(echo "$end_time - $start_time" | bc)
            echo "| $component | ${build_time}s |" >> $GITHUB_STEP_SUMMARY
          done
  docker-worker:
    if: github.ref == 'refs/heads/main' && (needs.changes.outputs.worker == 'true' || needs.changes.outputs.platform_libs == 'true')
    needs: [changes, platform-lint, platform-test]
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/docker-build-push.yml
    with:
      component: worker
      context: agentarea-platform
      dockerfile: agentarea-platform/apps/worker/Dockerfile
      use-private-registry: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY_MIRROR: ${{ secrets.DOCKER_REGISTRY_MIRROR }}
      DOCKER_REGISTRY_MIRROR_PATH: ${{ secrets.DOCKER_REGISTRY_MIRROR_PATH }}
      DOCKER_REGISTRY_MIRROR_USERNAME: ${{ secrets.DOCKER_REGISTRY_MIRROR_USERNAME }}
      DOCKER_REGISTRY_MIRROR_PASSWORD: ${{ secrets.DOCKER_REGISTRY_MIRROR_PASSWORD }}
  docker-frontend:
    if: github.ref == 'refs/heads/main' && needs.changes.outputs.webapp == 'true'
    needs: [changes, webapp-lint]
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/docker-build-push.yml
    with:
      component: frontend
      context: agentarea-webapp
      dockerfile: agentarea-webapp/Dockerfile
      use-private-registry: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY_MIRROR: ${{ secrets.DOCKER_REGISTRY_MIRROR }}
      DOCKER_REGISTRY_MIRROR_PATH: ${{ secrets.DOCKER_REGISTRY_MIRROR_PATH }}
      DOCKER_REGISTRY_MIRROR_USERNAME: ${{ secrets.DOCKER_REGISTRY_MIRROR_USERNAME }}
      DOCKER_REGISTRY_MIRROR_PASSWORD: ${{ secrets.DOCKER_REGISTRY_MIRROR_PASSWORD }}
  docker-bootstrap:
    if: github.ref == 'refs/heads/main' && needs.changes.outputs.bootstrap == 'true'
    needs: changes
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/docker-build-push.yml
    with:
      component: bootstrap
      context: agentarea-bootstrap
      dockerfile: agentarea-bootstrap/Dockerfile
      use-private-registry: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY_MIRROR: ${{ secrets.DOCKER_REGISTRY_MIRROR }}
      DOCKER_REGISTRY_MIRROR_PATH: ${{ secrets.DOCKER_REGISTRY_MIRROR_PATH }}
      DOCKER_REGISTRY_MIRROR_USERNAME: ${{ secrets.DOCKER_REGISTRY_MIRROR_USERNAME }}
      DOCKER_REGISTRY_MIRROR_PASSWORD: ${{ secrets.DOCKER_REGISTRY_MIRROR_PASSWORD }}
  docker-agentarea-mcp-manager:
    if: github.ref == 'refs/heads/main' && needs.changes.outputs.mcp_manager == 'true'
    needs: [changes, mcp-manager-lint-test]
    permissions:
      packages: write
      contents: read
    uses: ./.github/workflows/docker-build-push.yml
    with:
      component: mcp-manager
      context: agentarea-mcp-manager
      dockerfile: agentarea-mcp-manager/Dockerfile
      use-private-registry: true
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      DOCKER_REGISTRY_MIRROR: ${{ secrets.DOCKER_REGISTRY_MIRROR }}
      DOCKER_REGISTRY_MIRROR_PATH: ${{ secrets.DOCKER_REGISTRY_MIRROR_PATH }}
      DOCKER_REGISTRY_MIRROR_USERNAME: ${{ secrets.DOCKER_REGISTRY_MIRROR_USERNAME }}
      DOCKER_REGISTRY_MIRROR_PASSWORD: ${{ secrets.DOCKER_REGISTRY_MIRROR_PASSWORD }}

  webapp-lint:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.webapp == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'agentarea-webapp/pnpm-lock.yaml'

      - name: Install dependencies
        working-directory: agentarea-webapp
        run: pnpm install --frozen-lockfile

      - name: Run lint
        working-directory: agentarea-webapp
        run: pnpm run lint

  cli-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cli == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'agentarea-cli/package-lock.json'

      - name: Install dependencies
        working-directory: agentarea-cli
        run: npm ci || npm install

      - name: Run tests
        working-directory: agentarea-cli
        run: npm run test

  mcp-manager-lint-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mcp_manager == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run Go tests
        working-directory: agentarea-mcp-manager
        run: go test ./...

      # - name: Run golangci-lint
      #   uses: golangci/golangci-lint-action@v6
      #   with:
      #     version: latest
      #     working-directory: agentarea-mcp-manager
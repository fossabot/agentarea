# Default values for agentarea.
# This is a YAML-formatted file.
# Helm chart default values

# Service account configuration
serviceAccount:
  create: true
  annotations: {}
  name: &service-account-name "agentarea"  # YAML anchor for reuse

# Name overrides
nameOverride: ""
fullnameOverride: ""

# Global configuration shared across all components
global:
  # Edition and deployment info
  edition: "community"
  version: "0.0.1"
  
  # Cluster configuration
  cluster:
    type: "kubernetes"
    name: "agentarea"
  
  # Deployment environment
  deploymentEnv: "production"
  
  # Image configuration
  image:
    pullPolicy: IfNotPresent
    registry: ""  # Optional: Set custom registry (e.g., "myregistry.com", "ghcr.io")
    pullSecrets: []  # Optional: List of image pull secret names
    # - name: regcred

  # Service account (uses YAML anchor)
  serviceAccountName: *service-account-name

  # Secret references - users can create these secrets before installation
  # If secrets don't exist, they will be auto-generated
  secrets:
    # Main PostgreSQL database credentials
    postgresql: "agentarea-postgresql-secret"
    # Redis credentials
    redis: "agentarea-redis-secret"
    # MinIO/S3 credentials
    minio: "agentarea-minio-secret"
    # Application secrets (JWT, encryption keys)
    application: "agentarea-app-secrets"

  # Database configuration
  database:
    # Secret name where database credentials are stored
    secretName: "agentarea-postgresql-secret"
    # Database connection details
    host: ""  # Auto-set from postgresql.fullnameOverride if empty
    port: 5432
    name: "agentarea"  # Changed from 'database' to 'name' per v2.0
    # SSL configuration
    ssl: false
    sslMode: "prefer"
    # Connection pool settings
    maxConnections: 100
    connectionTimeout: 30s
    # Migration settings
    migrations:
      runAtStartup: true
      initializationTimeout: 300s

  # Redis configuration
  redis:
    host: ""  # Auto-set from redis.fullnameOverride if empty
    port: 6379
    # Redis settings
    database: 0
    ssl: false
    # Connection pool settings
    maxConnections: 50
    connectionTimeout: 5s

  # Storage configuration - S3/MinIO compatible
  storage:
    # Storage type (s3, minio, gcs)
    type: "minio"
    endpoint: ""  # Auto-set from minio service if empty
    bucket: "agentarea-documents"
    region: "us-east-1"
    # S3 settings
    s3:
      accessKeyId: ""
      secretAccessKey: ""
      sessionToken: ""
    # GCS settings
    gcs:
      projectId: ""
      credentials: ""
    # MinIO settings
    minio:
      accessKey: ""
      secretKey: ""

  # Temporal configuration - Workflow engine
  temporal:
    host: ""  # Auto-set from temporal service if empty
    port: 7233
    namespace: "default"
    taskQueue: "agent-tasks"
    # Temporal client settings
    client:
      connectionTimeout: 10s
      rpcTimeout: 10s
      longPollTimeout: 60s
    # Worker settings
    worker:
      maxConcurrentActivityExecutions: 10
      maxConcurrentWorkflowTaskExecutions: 5
      maxConcurrentSessionExecutions: 1000

  # API configuration
  api:
    # API server settings
    host: "0.0.0.0"
    port: 8000
    # Authentication
    auth:
      enabled: false
      headerName: ""
      headerValue: ""
    # Rate limiting
    rateLimit:
      enabled: true
      requestsPerMinute: 1000

  # Web application configuration
  webapp:
    url: ""  # Public URL of the frontend (e.g. https://app.example.com). If empty, defaults to internal service URL.
    
  # Jobs configuration - Background task processing
  jobs:
    kube:
      # Kubernetes job settings
      namespace: ""  # Use release namespace if empty
      serviceAccount: ""  # Use global service account if empty
      # Job scheduling
      scheduling:
        # Node selectors for different job types
        spec:
          nodeSelectors: {}
        check:
          nodeSelectors: {}
        discover:
          nodeSelectors: {}
      # Job resources
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 500m
          memory: 512Mi
      # Job timeouts
      timeouts:
        spec: 300s
        check: 600s
        discover: 900s
      # Image pull settings
      mainContainerImagePullPolicy: IfNotPresent
      sidecarContainerImagePullPolicy: IfNotPresent
      # Container images
      images:
        socat: "alpine/socat:latest"
        busybox: "busybox:latest"
        curl: "curlimages/curl:latest"

  # Workload configuration - Main application workloads
  workloads:
    resources:
      mainContainer:
        cpu:
          request: 50m
          limit: 1000m
        memory:
          request: 128Mi
          limit: 1Gi
      sidecarContainer:
        cpu:
          request: 10m
          limit: 200m
        memory:
          request: 64Mi
          limit: 256Mi

  # Service mesh configuration
  serviceMesh:
    enabled: false
    type: "istio"  # istio, linkerd

  # Monitoring configuration
  monitoring:
    # Prometheus metrics
    prometheus:
      enabled: true
      port: 9090
      path: "/metrics"
    # Health checks
    health:
      enabled: true
      port: 8001
      path: "/health"

  # Security configuration
  security:
    # Pod security context
    podSecurityContext:
      fsGroup: 1000
      runAsUser: 1000
      runAsNonRoot: true
    # Container security context
    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL

  # Extra labels to add to all resources
  extraLabels: {}
  # team: platform
  # environment: production

  # Extra selector labels for pods
  extraSelectorLabels: {}

# Ingress configuration
ingress:
  enabled: false
  # Ingress class name (nginx, traefik, etc.)
  className: ""
  # Annotations for ingress controller
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
  # Host configuration for each service
  hosts:
    frontend:
      host: ""  # e.g., app.example.com
      paths:
        - path: /
          pathType: Prefix
    backend:
      host: ""  # e.g., api.example.com
      paths:
        - path: /
          pathType: Prefix
    kratos:
      host: ""  # e.g., auth.example.com
      paths:
        - path: /
          pathType: Prefix
  # TLS configuration
  tls: []
    # - secretName: agentarea-tls
    #   hosts:
    #     - app.example.com
    #     - api.example.com
    #     - auth.example.com

# Backend API Service
backend:
  enabled: true
  replicaCount: 1

  image:
    repository: agentarea/agentarea-api
    tag: "latest"
    pullPolicy: ""  # Overrides global.image.pullPolicy if set

  service:
    type: ClusterIP
    port: 8000
    annotations: {}
    labels: {}

  # Resource limits and requests
  resources: {}
  #   limits:
  #     cpu: 1000m
  #     memory: 1Gi
  #   requests:
  #     cpu: 500m
  #     memory: 512Mi

  # Enhanced health check configuration
  livenessProbe:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Pod scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Pod annotations and labels
  podAnnotations: {}
  podLabels: {}

  # Additional configuration
  extraEnvFrom: []
  # - configMapRef:
  #     name: custom-config

  extraInitContainers: []
  # - name: init
  #   image: busybox:latest
  #   command: ['sh', '-c', 'echo initializing']

  # Security context
  podSecurityContext: {}
  #   fsGroup: 1000
  #   runAsUser: 1000
  #   runAsNonRoot: true

  containerSecurityContext: {}
  #   allowPrivilegeEscalation: false
  #   readOnlyRootFilesystem: true
  #   runAsNonRoot: true
  #   capabilities:
  #     drop:
  #       - ALL

  # Extension points
  extraEnv: []

  # Dependency wait initContainers (disable for production)
  waitForDependencies: false
  # - name: CUSTOM_VAR
  #   value: "custom-value"

# Frontend Service
frontend:
  enabled: true
  replicaCount: 1
  image:
    repository: agentarea/agentarea-frontend
    tag: "latest"
    pullPolicy: ""  # Overrides global.image.pullPolicy if set
  service:
    type: ClusterIP
    port: 3000
    annotations: {}
    labels: {}
  # Enhanced health checks
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  # Resource management
  resources: {}
  #   limits:
  #     cpu: 500m
  #     memory: 512Mi
  #   requests:
  #     cpu: 250m
  #     memory: 256Mi
  # Pod configuration
  podAnnotations: {}
  podLabels: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  # Additional configuration
  extraEnv: []
  extraVolumes: []
  extraVolumeMounts: []
  extraContainers: []

# Worker Service (Temporal worker)
worker:
  enabled: true
  replicaCount: 1
  image:
    repository: agentarea/agentarea-worker
    tag: "latest"
    pullPolicy: ""  # Overrides global.image.pullPolicy if set
  # Resource management
  resources: {}
  #   limits:
  #     cpu: 1000m
  #     memory: 1Gi
  #   requests:
  #     cpu: 500m
  #     memory: 512Mi
  # Pod configuration
  podAnnotations: {}
  podLabels: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
  # Additional configuration
  extraEnv: []
  extraVolumes: []
  extraVolumeMounts: []
  extraContainers: []

  # Dependency wait initContainers (disable for production)
  waitForDependencies: false

# MCP Manager Service
mcpManager:
  enabled: true
  replicaCount: 1
  image:
    repository: agentarea/agentarea-mcp-manager
    tag: "latest"
  service:
    type: ClusterIP
    port: 80
  # Requires privileged mode for Podman
  securityContext:
    privileged: true
    capabilities:
      add:
        - SYS_ADMIN
  resources: {}
  extraEnv: []

# Temporal Workflow Engine
temporal:
  enabled: true
  replicaCount: 1
  image:
    repository: temporalio/auto-setup
    tag: "1.29.1"
  
  # Database configuration
  database:
    name: "temporal"
  
  service:
    type: ClusterIP
    port: 7233
  resources: {}
  extraEnv: []

# Temporal UI
temporalUi:
  enabled: true
  replicaCount: 1
  image:
    repository: temporalio/ui
    tag: "2.39.0"
  service:
    type: ClusterIP
    port: 8080
  resources: {}
  extraEnv: []

# Bitnami PostgreSQL dependency configuration
postgresql:
  enabled: true
  auth:
    # Reference to existing secret (created by agentarea chart or user)
    existingSecret: "agentarea-postgresql-secret"
    secretKeys:
      adminPasswordKey: "postgres-password"
      userPasswordKey: "password"
    username: "postgres"
    database: "agentarea"
  primary:
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi
    persistence:
      enabled: true
      size: 8Gi

# Bitnami Redis dependency configuration
redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: "agentarea-redis-secret"
    existingSecretPasswordKey: "redis-password"
  master:
    resources:
      limits:
        cpu: 250m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi
    persistence:
      enabled: false  # Disable for development, enable for production

# Bitnami MinIO dependency configuration
minio:
  enabled: true
  image:
    repository: "minio/minio"
    tag: "latest"
  auth:
    existingSecret: "agentarea-minio-secret"
  defaultBuckets: "agentarea-documents"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  persistence:
    enabled: true
    size: 10Gi

# Job toggles
jobs:
  bootstrap:
    enabled: false
  dbMigration:
    enabled: false
  appMigration:
    enabled: false

# Ory Kratos Identity Server
kratos:
  enabled: true
  replicaCount: 1
  image:
    repository: oryd/kratos
    tag: "v1.3.1"
  
  # URL configuration
  # If not set, these default to internal Kubernetes service DNS names
  urls:
    public: "" # e.g. https://auth.example.com
    admin: ""  # e.g. http://kratos-admin.internal
  
  database:
    name: "kratos"

  configMapOverrideName: ""
  files: {}

  secretName: ""
  generateJwks: false
  smtp:
    connection_uri: ""
    from_address: "noreply@example.com"
    from_name: "AgentArea"
  session:
    cookieDomain: "localhost"
  jwt:
    kid: "agentarea-jwt-key-1"
    jwks_b64: "ewogICJrZXlzIjogWwogICAgewogICAgICAia3R5IjogIkVDIiwKICAgICAgImtpZCI6ICJhZ2VudGFyZWEtand0LWtleS0xIiwKICAgICAgInVzZSI6ICJzaWciLAogICAgICAiYWxnIjogIkVTMjU2IiwKICAgICAgImNydiI6ICJQLTI1NiIsCiAgICAgICJ4IjogIk1LQkNUTkljS1VTRGlpMTF5U3MzNTI2aURaOEFpVG83VHU2S1BBcXY3RDQiLAogICAgICAieSI6ICI0RXRsNlNSVzJZaUxVck41dmZ2Vkh1aHA3eDhQeGx0bVdXbGJiTTRJRnlNIiwKICAgICAgImQiOiAiODcwTUI2Z2Z1VEo0SHRVblV2WU15SnByNWVVWk5QNEJrNDNiVmRqM2VBRSIKICAgIH0KICBdCn0="
    claims_mapper_b64: "bG9jYWwgY2xhaW1zID0gc3RkLmV4dFZhcignY2xhaW1zJyk7CmxvY2FsIHNlc3Npb24gPSBzdGQuZXh0VmFyKCdzZXNzaW9uJyk7Cgp7CiAgY2xhaW1zOiB7CiAgICAvLyBTdGFuZGFyZCBKV1QgY2xhaW1zIC0gaW5oZXJpdCBmcm9tIGRlZmF1bHQgY2xhaW1zCiAgICBpc3M6ICdodHRwczovL2FnZW50YXJlYS5kZXYnLAogICAgc3ViOiBzZXNzaW9uLmlkZW50aXR5LmlkLAogICAgYXVkOiAnYWdlbnRhcmVhLWFwaScsCiAgICBleHA6IGNsYWltcy5leHAsCiAgICBpYXQ6IGNsYWltcy5pYXQsCgogICAgLy8gQ3VzdG9tIGNsYWltcwogICAgZW1haWw6IGlmIHN0ZC5vYmplY3RIYXMoc2Vzc2lvbi5pZGVudGl0eS50cmFpdHMsICdlbWFpbCcpIHRoZW4gc2Vzc2lvbi5pZGVudGl0eS50cmFpdHMuZW1haWwgZWxzZSBudWxsLAogICAgdXNlcm5hbWU6IGlmIHN0ZC5vYmplY3RIYXMoc2Vzc2lvbi5pZGVudGl0eS50cmFpdHMsICd1c2VybmFtZScpIHRoZW4gc2Vzc2lvbi5pZGVudGl5LnRyYWl0cy51c2VybmFtZSBlbHNlIG51bGwsCiAgICBuYW1lOiBpZiBzdGQub2JqZWN0SGFzKHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLCAnbmFtZScpIHRoZW4gewogICAgICBmaXJzdDogaWYgc3RkLm9iamVjdEhhcyhzZXNzaW9uLmlkZW50aXR5LnRyYWl0cy5uYW1lLCAnZmlyc3QnKSB0aGVuIHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLm5hbWUuZmlyc3QgZWxzZSBudWxsLAogICAgICBsYXN0OiBpZiBzdGQub2JqZWN0SGFzKHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLm5hbWUsICdsYXN0JykgdGhlbiBzZXNzaW9uLmlkZW50aXR5LnRyYWl0cy5uYW1lLmxhc3QgZWxzZSBudWxsLAogICAgfSBlbHNlIG51bGwsCgogICAgLy8gS3JhdG9zIHNwZWNpZmljIGNsYWltcwogICAgc2NoZW1hX2lkOiBzZXNzaW9uLmlkZW50aXR5LnNjaGVtYV9pZCwKICAgIGFhbDogc2Vzc2lvbi5hdXRoZW50aWNhdG9yX2Fzc3VyYW5jZV9sZXZlbCwKICAgIHNlc3Npb25faWQ6IHNlc3Npb24uaWQsCiAgfQp9Cg=="
    issuer: "https://agentarea.dev"
    audience: "agentarea-api"

  # Kratos Identity Schema
  identitySchema: |
    {
      "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Person",
      "type": "object",
      "properties": {
        "traits": {
          "type": "object",
          "properties": {
            "email": {
              "type": "string",
              "format": "email",
              "title": "Email",
              "ory.sh/kratos": {
                "credentials": {
                  "password": {
                    "identifier": true
                  }
                },
                "recovery": {
                  "via": "email"
                }
              }
            },
            "name": {
              "type": "object",
              "properties": {
                "first": {
                  "title": "First Name",
                  "type": "string"
                },
                "last": {
                  "title": "Last Name",
                  "type": "string"
                }
              }
            },
            "username": {
              "type": "string",
              "title": "Username"
            }
          },
          "required": [
            "email"
          ],
          "additionalProperties": false
        }
      }
    }

  # Kratos Configuration (kratos.yml)
  # Provide a pure YAML map here (no Helm templating). Dynamic fields (URLs, SMTP, cookie domain,
  # whoami tokenizer) are injected by the chart at render time.
  config:
    version: v1.3.1
    serve:
      public:
        cors:
          enabled: true
          allowed_origins:
            - https://staging-0.agentarea.ai
            - https://*.staging-0.agentarea.ai
          allowed_methods:
            - POST
            - GET
            - PUT
            - PATCH
            - DELETE
          allowed_headers:
            - Authorization
            - Cookie
            - Content-Type
            - X-Session-Token
          exposed_headers:
            - Content-Type
            - Set-Cookie
    dsn: ${DSN}
    secrets:
      cookie:
        - PLEASE-CHANGE-ME-I-AM-VERY-INSECURE-dev-only
      cipher:
        - SECRET-KEY-FOR-DEV-32-CHARACTERS
    ciphers:
      algorithm: xchacha20-poly1305
    hashers:
      algorithm: bcrypt
      bcrypt:
        cost: 8
    identity:
      default_schema_id: default
      schemas:
        - id: default
          url: file:///etc/config/kratos/identity.schema.json

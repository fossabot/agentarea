{{- if .Values.kratos.enabled }}
{{- $frontendUrl := .Values.global.webapp.url | default (printf "http://%s-frontend:3000" (include "agentarea.fullname" .)) | trimSuffix "/" -}}
{{- $kratosPublicUrl := .Values.kratos.urls.public | default (printf "http://%s-kratos-public:4433" (include "agentarea.fullname" .)) | trimSuffix "/" -}}
{{- $kratosAdminUrl := .Values.kratos.urls.admin | default (printf "http://%s-kratos-admin:4434" (include "agentarea.fullname" .)) | trimSuffix "/" -}}
{{- $kratosConfigMapName := default (printf "%s-kratos-config" (include "agentarea.fullname" .)) .Values.kratos.configMapOverrideName -}}
{{- if not .Values.kratos.configMapOverrideName }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $kratosConfigMapName }}
  labels:
    {{- include "agentarea.labels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
data:
  identity.schema.json: |
{{ .Values.kratos.identitySchema | indent 4 }}
  kratos.yml: |
{{- $cfg := deepCopy (default dict .Values.kratos.config) -}}
{{- /* serve.public.base_url */ -}}
{{- $serve := get $cfg "serve" | default dict -}}
{{- $_ := set $cfg "serve" $serve -}}
{{- $public := get $serve "public" | default dict -}}
{{- if not (hasKey $public "base_url") -}}
{{- $_ = set $public "base_url" (printf "%s/" $kratosPublicUrl) -}}
{{- end -}}
{{- $_ = set $serve "public" $public -}}
{{- /* serve.admin.base_url */ -}}
{{- $admin := get $serve "admin" | default dict -}}
{{- if not (hasKey $admin "base_url") -}}
{{- $_ = set $admin "base_url" (printf "%s/" $kratosAdminUrl) -}}
{{- end -}}
{{- $_ = set $serve "admin" $admin -}}
{{- /* selfservice defaults */ -}}
{{- $self := get $cfg "selfservice" | default dict -}}
{{- if not (hasKey $self "default_browser_return_url") -}}
{{- $_ = set $self "default_browser_return_url" (printf "%s/" $frontendUrl) -}}
{{- end -}}
{{- $allowed := get $self "allowed_return_urls" | default list -}}
{{- if eq (len $allowed) 0 -}}
{{- $_ = set $self "allowed_return_urls" (list $frontendUrl (printf "%s/workplace" $frontendUrl) (printf "%s/dashboard" $frontendUrl)) -}}
{{- end -}}
{{- $flows := get $self "flows" | default dict -}}
{{- $flowError := get $flows "error" | default dict -}}
{{- if not (hasKey $flowError "ui_url") -}}{{- $_ = set $flowError "ui_url" (printf "%s/auth/error" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flows "error" $flowError -}}
{{- $flowSettings := get $flows "settings" | default dict -}}
{{- if not (hasKey $flowSettings "ui_url") -}}{{- $_ = set $flowSettings "ui_url" (printf "%s/auth/settings" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flows "settings" $flowSettings -}}
{{- $flowRecovery := get $flows "recovery" | default dict -}}
{{- if not (hasKey $flowRecovery "ui_url") -}}{{- $_ = set $flowRecovery "ui_url" (printf "%s/auth/recovery" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flows "recovery" $flowRecovery -}}
{{- $flowVerification := get $flows "verification" | default dict -}}
{{- if not (hasKey $flowVerification "ui_url") -}}{{- $_ = set $flowVerification "ui_url" (printf "%s/auth/verification" $frontendUrl) -}}{{- end -}}
{{- $verAfter := get $flowVerification "after" | default dict -}}
{{- if not (hasKey $verAfter "default_browser_return_url") -}}{{- $_ = set $verAfter "default_browser_return_url" (printf "%s/workplace" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flowVerification "after" $verAfter -}}
{{- $_ = set $flows "verification" $flowVerification -}}
{{- $flowLogout := get $flows "logout" | default dict -}}
{{- $logoutAfter := get $flowLogout "after" | default dict -}}
{{- if not (hasKey $logoutAfter "default_browser_return_url") -}}{{- $_ = set $logoutAfter "default_browser_return_url" (printf "%s/auth/login" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flowLogout "after" $logoutAfter -}}
{{- $_ = set $flows "logout" $flowLogout -}}
{{- $flowLogin := get $flows "login" | default dict -}}
{{- if not (hasKey $flowLogin "ui_url") -}}{{- $_ = set $flowLogin "ui_url" (printf "%s/auth/login" $frontendUrl) -}}{{- end -}}
{{- $loginAfter := get $flowLogin "after" | default dict -}}
{{- if not (hasKey $loginAfter "default_browser_return_url") -}}{{- $_ = set $loginAfter "default_browser_return_url" (printf "%s/workplace" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flowLogin "after" $loginAfter -}}
{{- $_ = set $flows "login" $flowLogin -}}
{{- $flowRegistration := get $flows "registration" | default dict -}}
{{- if not (hasKey $flowRegistration "ui_url") -}}{{- $_ = set $flowRegistration "ui_url" (printf "%s/auth/registration" $frontendUrl) -}}{{- end -}}
{{- $regAfter := get $flowRegistration "after" | default dict -}}
{{- if not (hasKey $regAfter "default_browser_return_url") -}}{{- $_ = set $regAfter "default_browser_return_url" (printf "%s/workplace" $frontendUrl) -}}{{- end -}}
{{- $_ = set $flowRegistration "after" $regAfter -}}
{{- $_ = set $flows "registration" $flowRegistration -}}
{{- $_ = set $self "flows" $flows -}}
{{- $_ = set $cfg "selfservice" $self -}}
{{- /* SMTP courier if connection_uri provided */ -}}
{{- if .Values.kratos.smtp.connection_uri -}}
{{- $courier := get $cfg "courier" | default dict -}}
{{- $smtp := get $courier "smtp" | default dict -}}
{{- $_ = set $smtp "connection_uri" (.Values.kratos.smtp.connection_uri | quote) -}}
{{- $_ = set $smtp "from_address" (default "noreply@example.com" .Values.kratos.smtp.from_address) -}}
{{- $_ = set $smtp "from_name" (default "AgentArea" .Values.kratos.smtp.from_name) -}}
{{- $_ = set $courier "smtp" $smtp -}}
{{- $_ = set $cfg "courier" $courier -}}
{{- end -}}
{{- /* session cookie and whoami tokenizer */ -}}
{{- $session := get $cfg "session" | default dict -}}
{{- $cookie := get $session "cookie" | default dict -}}
{{- if not (hasKey $cookie "same_site") -}}{{- $_ = set $cookie "same_site" "Lax" -}}{{- end -}}
{{- if not (hasKey $cookie "domain") -}}{{- $_ = set $cookie "domain" (default "localhost" .Values.kratos.session.cookieDomain) -}}{{- end -}}
{{- if not (hasKey $cookie "path") -}}{{- $_ = set $cookie "path" "/" -}}{{- end -}}
{{- $_ = set $session "cookie" $cookie -}}
{{- $whoami := get $session "whoami" | default dict -}}
{{- $tokenizer := get $whoami "tokenizer" | default dict -}}
{{- $templates := get $tokenizer "templates" | default dict -}}
{{- $agentJwt := get $templates "agentarea_jwt" | default dict -}}
{{- $_ = set $agentJwt "jwks_url" "file:///etc/config/kratos/keys/jwks.json" -}}
{{- $_ = set $agentJwt "claims_mapper_url" (printf "base64://%s" (default "bG9jYWwgY2xhaW1zID0gc3RkLmV4dFZhcignY2xhaW1zJyk7CmxvY2FsIHNlc3Npb24gPSBzdGQuZXh0VmFyKCdzZXNzaW9uJyk7Cgp7CiAgY2xhaW1zOiB7CiAgICAvLyBTdGFuZGFyZCBKV1QgY2xhaW1zIC0gaW5oZXJpdCBmcm9tIGRlZmF1bHQgY2xhaW1zCiAgICBpc3M6ICdodHRwczovL2FnZW50YXJlYS5kZXYnLAogICAgc3ViOiBzZXNzaW9uLmlkZW50aXR5LmlkLAogICAgYXVkOiAnYWdlbnRhcmVhLWFwaScsCiAgICBleHA6IGNsYWltcy5leHAsCiAgICBpYXQ6IGNsYWltcy5pYXQsCgogICAgLy8gQ3VzdG9tIGNsYWltcwogICAgZW1haWw6IGlmIHN0ZC5vYmplY3RIYXMoc2Vzc2lvbi5pZGVudGl0eS50cmFpdHMsICdlbWFpbCcpIHRoZW4gc2Vzc2lvbi5pZGVudGl0eS50cmFpdHMuZW1haWwgZWxzZSBudWxsLAogICAgdXNlcm5hbWU6IGlmIHN0ZC5vYmplY3RIYXMoc2Vzc2lvbi5pZGVudGl5LnRyYWl0cy51c2VybmFtZSBlbHNlIG51bGwsCiAgICBuYW1lOiBpZiBzdGQub2JqZWN0SGFzKHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLCAnbmFtZScpIHRoZW4gewogICAgICBmaXJzdDogaWYgc3RkLm9iamVjdEhhcyhzZXNzaW9uLmlkZW50aXR5LnRyYWl0cy5uYW1lLCAnZmlyc3QnKSB0aGVuIHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLm5hbWUuZmlyc3QgZWxzZSBudWxsLAogICAgICBsYXN0OiBpZiBzdGQub2JqZWN0SGFzKHNlc3Npb24uaWRlbnRpdHkudHJhaXRzLm5hbWUsICdsYXN0JykgdGhlbiBzZXNzaW9uLmlkZW50aXR5LnRyYWl0cy5uYW1lLmxhc3QgZWxzZSBudWxsLAogICAgfSBlbHNlIG51bGwsCgogICAgLy8gS3JhdG9zIHNwZWNpZmljIGNsYWltcwogICAgc2NoZW1hX2lkOiBzZXNzaW9uLmlkZW50aXR5LnNjaGVtYV9pZCwKICAgIGFhbDogc2Vzc2lvbi5hdXRoZW50aWNhdG9yX2Fzc3VyYW5jZV9sZXZlbCwKICAgIHNlc3Npb25faWQ6IHNlc3Npb24uaWQsCiAgfQp9Cg==" .Values.kratos.jwt.claims_mapper_b64)) -}}
{{- $_ = set $agentJwt "ttl" "30m" -}}
{{- $_ = set $templates "agentarea_jwt" $agentJwt -}}
{{- $_ = set $tokenizer "templates" $templates -}}
{{- $_ = set $whoami "tokenizer" $tokenizer -}}
{{- $_ = set $session "whoami" $whoami -}}
{{- $_ = set $cfg "session" $session -}}
{{- toYaml $cfg | nindent 4 -}}
{{- range $filename, $content := .Values.kratos.files }}
  {{ $filename }}: |
{{- tpl $content $ | nindent 4 }}
{{- end }}
{{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "agentarea.fullname" . }}-kratos
  labels:
    {{- include "agentarea.labels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
spec:
  replicas: {{ default 1 .Values.kratos.replicaCount }}
  selector:
    matchLabels:
      {{- include "agentarea.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: kratos
  template:
    metadata:
      labels:
        {{- include "agentarea.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: kratos
    spec:
      serviceAccountName: {{ include "agentarea.serviceAccountName" . }}
      containers:
        - name: kratos
          image: "{{ default "" .Values.global.image.registry }}{{ if .Values.global.image.registry }}/{{ end }}{{ default "oryd/kratos" .Values.kratos.image.repository }}:{{ default "v1.3.1" .Values.kratos.image.tag }}"
          imagePullPolicy: {{ .Values.global.image.pullPolicy }}
          ports:
            - name: public
              containerPort: 4433
              protocol: TCP
            - name: admin
              containerPort: 4434
              protocol: TCP
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: "{{ .Values.global.secrets.postgresql }}"
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "{{ .Values.global.secrets.postgresql }}"
                  key: password
            - name: DSN
              value: "postgres://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@{{ .Release.Name }}-postgresql:{{ .Values.global.database.port }}/{{ .Values.kratos.database.name | default "kratos" }}?sslmode=disable&max_conns=20&max_idle_conns=4"
          command: ["sh","-c"]
          args:
            - >
              echo "Checking Env...";
              env | grep POSTGRES;
              echo "DSN: $DSN";
              kratos serve -c /etc/config/kratos/kratos.yml --dev --watch-courier
          volumeMounts:
            - name: kratos-config
              mountPath: /etc/config/kratos
            - name: kratos-jwks
              mountPath: /etc/config/kratos/keys
          readinessProbe:
            httpGet:
              path: /health/ready
              port: public
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health/alive
              port: public
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 6
      volumes:
        - name: kratos-config
          configMap:
            name: {{ $kratosConfigMapName }}
        - name: kratos-jwks
          secret:
            secretName: {{ default (printf "%s-kratos-jwks" .Release.Name) .Values.kratos.secretName }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "agentarea.fullname" . }}-kratos-public
  labels:
    {{- include "agentarea.labels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
spec:
  type: ClusterIP
  ports:
    - port: 4433
      targetPort: public
      protocol: TCP
      name: http
  selector:
    {{- include "agentarea.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "agentarea.fullname" . }}-kratos-admin
  labels:
    {{- include "agentarea.labels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
spec:
  type: ClusterIP
  ports:
    - port: 4434
      targetPort: admin
      protocol: TCP
      name: http
  selector:
    {{- include "agentarea.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: kratos
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "agentarea.fullname" . }}-kratos-migrate
  labels:
    {{- include "agentarea.labels" . | nindent 4 }}
    app.kubernetes.io/component: kratos-migrate
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "4"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      labels:
        {{- include "agentarea.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: kratos-migrate
    spec:
      restartPolicy: Never
      containers:
        - name: kratos-migrate
          image: "{{ default "" .Values.global.image.registry }}{{ if .Values.global.image.registry }}/{{ end }}{{ default "oryd/kratos" .Values.kratos.image.repository }}:{{ default "v1.3.1" .Values.kratos.image.tag }}"
          imagePullPolicy: {{ .Values.global.image.pullPolicy }}
          command: ["sh","-c"]
          args:
            - |
              echo "Checking environment..."
              env | grep POSTGRES
              echo "Constructing DSN..."
              export DSN="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@{{ .Release.Name }}-postgresql:{{ .Values.global.database.port }}/{{ .Values.kratos.database.name | default "kratos" }}?sslmode=disable&max_conns=20&max_idle_conns=4"
              if [ -z "$DSN" ]; then
                echo "Error: DSN is empty"
                exit 1
              fi
              echo "DSN is set"
              kratos migrate sql "$DSN" -e --yes
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: "{{ .Values.global.secrets.postgresql }}"
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "{{ .Values.global.secrets.postgresql }}"
                  key: password
{{- end }}
